<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/d2662e35/css/bootstrap.css" rel="stylesheet">
<link href="./assets/554be0b5/solarized_light.css" rel="stylesheet">
<link href="./assets/d6669f61/style.css" rel="stylesheet">
<script src="./assets/264bf9c7/jquery.js"></script>
<script src="./assets/d2662e35/js/bootstrap.js"></script>    <title>Dynamic Active Record</title>
</head>
<body>

<div class="wrap">
    <nav id="w95" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w95-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./index.html">Dynamic Active Record</a></div><div id="w95-collapse" class="collapse navbar-collapse"><ul id="w96" class="navbar-nav nav"></ul></div></nav>
    
<div class="row">
    <div class="col-md-3">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-92" data-toggle="collapse" data-parent="#navigation">spinitron\dynamicAr <b class="caret"></b></a><div id="navigation-92" class="submenu panel-collapse collapse"><a class="list-group-item" href="./spinitron-dynamicar-dynamicactivequery.html">DynamicActiveQuery</a>
<a class="list-group-item" href="./spinitron-dynamicar-dynamicactiverecord.html">DynamicActiveRecord</a>
<a class="list-group-item" href="./spinitron-dynamicar-valueexpression.html">ValueExpression</a></div>
<a class="list-group-item" href="#navigation-93" data-toggle="collapse" data-parent="#navigation">yii\base <b class="caret"></b></a><div id="navigation-93" class="submenu panel-collapse collapse"><a class="list-group-item" href="./yii-base-arrayable.html">Arrayable</a>
<a class="list-group-item" href="./yii-base-arrayabletrait.html">ArrayableTrait</a>
<a class="list-group-item" href="./yii-base-component.html">Component</a>
<a class="list-group-item" href="./yii-base-configurable.html">Configurable</a>
<a class="list-group-item" href="./yii-base-model.html">Model</a>
<a class="list-group-item" href="./yii-base-object.html">Object</a></div>
<a class="list-group-item" href="#navigation-94" data-toggle="collapse" data-parent="#navigation">yii\db <b class="caret"></b></a><div id="navigation-94" class="submenu panel-collapse collapse"><a class="list-group-item" href="./yii-db-activequery.html">ActiveQuery</a>
<a class="list-group-item" href="./yii-db-activequeryinterface.html">ActiveQueryInterface</a>
<a class="list-group-item" href="./yii-db-activequerytrait.html">ActiveQueryTrait</a>
<a class="list-group-item" href="./yii-db-activerecord.html">ActiveRecord</a>
<a class="list-group-item" href="./yii-db-activerecordinterface.html">ActiveRecordInterface</a>
<a class="list-group-item" href="./yii-db-activerelationtrait.html">ActiveRelationTrait</a>
<a class="list-group-item" href="./yii-db-baseactiverecord.html">BaseActiveRecord</a>
<a class="list-group-item" href="./yii-db-query.html">Query</a>
<a class="list-group-item" href="./yii-db-queryinterface.html">QueryInterface</a>
<a class="list-group-item" href="./yii-db-querytrait.html">QueryTrait</a></div></div>    </div>
    <div class="col-md-9 api-content" role="main">
        <h1>Dynamic Active Record <span id="dynamic-active-record"></span><a href="#dynamic-active-record" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#example">Example</a></li>
<li><a href="#design-principle">Design principle</a></li>
<li><a href="#further-reading">Further reading</a></li>
<li><a href="#questions-comments-issues">Questions, comments, issues</a></li></ol></div>
<p>The <a href="https://github.com/tom--/dynamic-ar">yii2-dynamic-ar</a> extension adds NoSQL-like documents to
<a href="http://www.yiiframework.com/">Yii 2 Framework</a>'s
<a href="http://www.yiiframework.com/doc-2.0/guide-db-active-record.html">Active Record ORM</a>.</p>
<h3>Maria Dynamic Columns and PostgreSQL jsonb <span id="maria-dynamic-columns-and-postgresql-jsonb"></span><a href="#maria-dynamic-columns-and-postgresql-jsonb" class="hashlink">&para;</a></h3><p><a href="https://mariadb.com/kb/en/mariadb/dynamic-columns/">Dynamic Columns</a>
in <a href="https://mariadb.com/kb/en/mariadb/what-is-mariadb-100/">Maria 10.0</a>+
and <a href="http://www.postgresql.org/docs/9.4/static/datatype-json.html">jsonb column types</a>
and <a href="http://www.postgresql.org/docs/9.4/static/functions-json.html">functions</a> in
in <a href="http://www.postgresql.org/">PostgreSQL 9.4</a>+
provide, in effect, a <a href="https://en.wikipedia.org/wiki/Document-oriented_database">NoSQL document</a>
attached to every row of an SQL table. It's a powerful
feature that allows you to do things that have been hard in relational DBs.
Problems that might drive you to Couch or Mongo, or to commit a crime like
<a href="https://en.wikipedia.org/wiki/Entity%E2%80%93attribute%E2%80%93value_model">EAV</a>
to your schema, can suddenly be easy when</p>
<ul>
<li>records can have any number of attributes,</li>
<li>attribute names can be made up on the fly,</li>
<li>the dynamic attribute names don't appear in the schema,</li>
<li>dynamic attributes can be structured like an associative array.</li>
</ul>
<p>Dynamic AR works for Maria now and will come to PostgreSQL in the future.</p>
<h2>Example <span id="example"></span><a href="#example" class="hashlink">&para;</a></h2><p>An online shopping site has a table that stores info about each product.</p>
<pre><code class="hljs sql language-sql"><span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> product (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>,
    sku <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">32</span>),
    upc <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">32</span>),
    title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    price <span class="hljs-built_in">DECIMAL</span>(<span class="hljs-number">9</span>, <span class="hljs-number">2</span>),
    stock <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>),
    details LONGBLOB <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
);</span>
</code></pre>
<p>In this (simplistic) example, <code>details</code> will hold the Maria
<a href="https://mariadb.com/kb/en/mariadb/dynamic-columns/">Dynamic Column blob</a> and is
declared in the model class by the <code>dynamicColumn()</code> method. Everything else in a Dynamic AR
class declaration is familiar AR stuff.</p>
<pre><code class="hljs php language-php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Product</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">spinitron</span>\<span class="hljs-title">dynamicAr</span>\<span class="hljs-title">DynamicActiveRecord</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tableName</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'product'</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dynamicColumn</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'details'</span>;
    }
}
</code></pre>
<p>Now we can do all the normal AR things with <code>Product</code> but in addition we can read, write and
update attributes not mentioned in the schema.</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$product</span> = <span class="hljs-keyword">new</span> Product([
    <span class="hljs-string">'sku'</span> =&gt; <span class="hljs-number">5463</span>,
    <span class="hljs-string">'upc'</span> =&gt; <span class="hljs-string">'234569'</span>,
    <span class="hljs-string">'price'</span> =&gt; <span class="hljs-number">4.99</span>,
    <span class="hljs-string">'title'</span> =&gt; <span class="hljs-string">'Clue-by-four'</span>,
    <span class="hljs-string">'description'</span> =&gt; <span class="hljs-string">'Used for larting lusers or constructing things'</span>,
    <span class="hljs-string">'dimensions'</span> =&gt; [
        <span class="hljs-string">'unit'</span> =&gt; <span class="hljs-string">'inch'</span>,
        <span class="hljs-string">'width'</span> =&gt; <span class="hljs-number">4</span>,
        <span class="hljs-string">'height'</span> =&gt; <span class="hljs-number">2</span>,
        <span class="hljs-string">'length'</span> =&gt; <span class="hljs-number">20</span>,
    ],
    <span class="hljs-string">'material'</span> =&gt; <span class="hljs-string">'wood'</span>,
]);
<span class="hljs-variable">$product</span>-&gt;save();
</code></pre>
<p>Think of the <code>details</code> table column as holding a serialized associative array. But unlike
saving a JSON document in a text field, you can use dynamic attributes anywhere in your code,
including in queries,
just as you do with schema attributes. The differences are</p>
<ul>
<li>Nested attributes use dotted notation, e.g. <code>dimensions.length</code></li>
<li>Direct get and set of nested attributes on a model instance use the <code>getAttribute()</code>
and <code>setAttribute()</code> methods because PHP doesn't allow dotted notation in identifiers.</li>
<li>When a dynamic attribute appears in a query, wrap it in bang-parens <code>(! … !)</code>,
e.g. <code>(! dimensions.length !)</code>. (Space between attribute name and its bang-parens is
optional so <code>(!material!)</code> is fine.)</li>
</ul>
<p>For example</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$model</span> = <span class="hljs-keyword">new</span> Product([
    <span class="hljs-string">'title'</span> =&gt; <span class="hljs-string">'Car'</span>,
    <span class="hljs-string">'specs.fuel.tank.capacity'</span> =&gt; <span class="hljs-number">50</span>,
    <span class="hljs-string">'specs.fuel.tank.capacity.unit'</span> =&gt; <span class="hljs-string">'liter'</span>,
]);
<span class="hljs-variable">$model</span>-&gt;setAttribute(<span class="hljs-string">'specs.wheels.count'</span>, <span class="hljs-number">4</span>);
<span class="hljs-variable">$model</span> = Product::find()-&gt;where([<span class="hljs-string">'(!dimensions.length!)'</span> =&gt; <span class="hljs-number">10</span>]);
<span class="hljs-variable">$section</span> = Product::find()
    -&gt;select(<span class="hljs-string">'CONCAT((! dimensions.width !), " x ", (! dimensions.height !))'</span>)
    -&gt;where([<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">11</span>])
    -&gt;one();
</code></pre>
<p>The dot notation works anywhere Yii accepts an attribute name string, for example</p>
<pre><code class="hljs php language-php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Product</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">spinitron</span>\<span class="hljs-title">dynamicAr</span>\<span class="hljs-title">DynamicActiveRecord</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [[<span class="hljs-string">'dimensions.length'</span>, <span class="hljs-string">'double'</span>, <span class="hljs-string">'min'</span> =&gt; <span class="hljs-number">0.0</span>]];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-variable">$params</span>)</span>
    </span>{
        <span class="hljs-variable">$dataProvider</span> = <span class="hljs-keyword">new</span> \yii\data\ActiveDataProvider([
            <span class="hljs-string">'sort'</span> =&gt; [
                <span class="hljs-string">'attributes'</span> =&gt; [
                    <span class="hljs-string">'dimensions.length'</span> =&gt; [
                        <span class="hljs-string">'asc'</span> =&gt; [<span class="hljs-string">'(! dimensions.length !)'</span> =&gt; SORT_DESC],
                        <span class="hljs-string">'desc'</span> =&gt; [<span class="hljs-string">'(! dimensions.length !)'</span> =&gt; SORT_ASC],
                    ],
                ],
            ],
            <span class="hljs-comment">// ...</span>
        ]);
    }
}
</code></pre>
<h2>Design principle <span id="design-principle"></span><a href="#design-principle" class="hashlink">&para;</a></h2><p>DynamicActiveRecord adds a fourth to the three things that reading and writing
AR model properties can do:</p>
<ol>
<li><code>$model-&gt;foo</code> accesses, if it exists, the instance variable <code>$foo</code>,</li>
<li>otherwise it accesses the column attribute <code>foo</code>, if the model's table has a column "foo",</li>
<li>otherwise it accesses the virtual attribute <code>foo</code>, if the model's class has
magic <code>getFoo()</code> / <code>setFoo()</code> methods,</li>
<li>else <code>$model-&gt;foo</code> accesses a dynamic attribute named "foo".</li>
</ol>
<p>So any attribute name that doesn't refer to one of the normal 3 kinds of
AR model property (instance variable, column attribute, virtual
attribute) is automatically a dynamic property as soon
as you use it. There is no way to declare a dynamic property and you can
only define one by writing to it.</p>
<p>And reading an attribute that doesn't exist returns null.</p>
<h4>PHP null, SQL NULL and Maria <span id="php-null-sql-null-and-maria"></span><a href="#php-null-sql-null-and-maria" class="hashlink">&para;</a></h4><p>Maria does not encode a dynamic column set to SQL NULL:</p>
<pre><code class="hljs sql language-sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> COLUMN_CREATE(<span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'b'</span>, <span class="hljs-literal">null</span>) = COLUMN_CREATE(<span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>)
&gt;&gt; <span class="hljs-number">1</span>
</span></code></pre>
<p>Thus if a table record currently has a dynamic column 'b' and Maria executes an
update setting it to NULL then Maria removes 'b' from the record. (This
makes sense if NULL has its conventional database meaning of 'data value
does not exist.') So DynamicActiveRecord cannot possibly distinguish a NULL
value from a dynamic column that doesn't exist after reading back from the DB.</p>
<p>In order to be consistent, DynamicActiveRecord always returns null when you
read a dynamic attribute that hasn't been set, in contrast to
ActiveRecord which throws an exception. But it also makes sense if
null means 'does not exist' and given the design principle (above).</p>
<h2>Further reading <span id="further-reading"></span><a href="#further-reading" class="hashlink">&para;</a></h2><p>Class reference</p>
<ul>
<li><a href="http://tom--.github.io/yii2-dynamic-ar/">Docs landing page</a></li>
<li><a href="http://tom--.github.io/yii2-dynamic-ar/spinitron-dynamicar-dynamicactiverecord.html">DynamciActiveRecord</a></li>
<li><a href="http://tom--.github.io/yii2-dynamic-ar/spinitron-dynamicar-dynamicactivequery.html">DynamicActiveQuery</a></li>
<li><a href="http://tom--.github.io/yii2-dynamic-ar/spinitron-dynamicar-valueexpression.html">ValueExpression</a></li>
</ul>
<p>More documentation</p>
<ul>
<li><a href="http://tom--.github.io/yii2-dynamic-ar/doc-datatypes.html">Datatypes</a> in PHP, SQL and JSON are not identical.</li>
<li><a href="http://tom--.github.io/yii2-dynamic-ar/doc-design.html">Design history</a> – The projects original README.</li>
</ul>
<p>Useful links</p>
<ul>
<li><a href="https://github.com/tom--/dynamic-ar">yii2-dynamic-ar project repo</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/guide-index.html">Yii 2 Framework</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/guide-db-active-record.html">Active Record guide</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/guide-db-query-builder.html">Query Builder guide</a></li>
<li><a href="https://mariadb.com/kb/en/mariadb/dynamic-columns/">Maria Dynamic Columns</a></li>
<li><a href="https://github.com/tom--/sequel-pro-maria-dynamic-column">Sequel Pro Dynamic Columns bundle</a></li>
</ul>
<p>Regenerate docs in gh-pages branch</p>
<pre><code class="hljs apache"><span class="hljs-keyword">vendor</span>/bin/apidoc api . . --template=<span class="hljs-string">"spinitron\dynamicAr\doc\template\ApiRenderer"</span>
</code></pre>
<h2>Questions, comments, issues <span id="questions-comments-issues"></span><a href="#questions-comments-issues" class="hashlink">&para;</a></h2><p>Use the <a href="dynamic-ar/dynamic-ar/issues">issue tracker</a>. Or you can easily find my email if you prefer.</p>
<hr />
<p>Copyright (c) 2015 Spinitron LLC</p>
<h1>Class Reference</h1>

<table class="summaryTable docIndex table table-bordered table-striped table-hover">
    <colgroup>
        <col class="col-package" />
        <col class="col-class" />
        <col class="col-description" />
    </colgroup>
    <tr>
        <th>Class</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><a href="spinitron-dynamicar-dynamicactivequery.html">spinitron\dynamicAr\DynamicActiveQuery</a></td>
        <td>DynamicActiveQuery represents queries on relational data with structured dynamic attributes.</td>
    </tr>
    <tr>
        <td><a href="spinitron-dynamicar-dynamicactiverecord.html">spinitron\dynamicAr\DynamicActiveRecord</a></td>
        <td>DynamicActiveRecord represents relational data with structured dynamic attributes
in addition to column attributes supported by ActiveRecord.</td>
    </tr>
    <tr>
        <td><a href="spinitron-dynamicar-valueexpression.html">spinitron\dynamicAr\ValueExpression</a></td>
        <td>A ValueExpression object represents the value of a dynamic attribute that DynamicActiveRecord
uses directly (unescaped) in SQL instead of using
<a href="http://php.net/manual/en/pdostatement.bindvalue.php">PDOStatement::bindValue</a>.</td>
    </tr>
    <tr>
        <td><a href="yii-base-arrayable.html">yii\base\Arrayable</a></td>
        <td>Arrayable is the interface that should be implemented by classes who want to support customizable representation of their instances.</td>
    </tr>
    <tr>
        <td><a href="yii-base-arrayabletrait.html">yii\base\ArrayableTrait</a></td>
        <td>ArrayableTrait provides a common implementation of the <a href="yii-base-arrayable.html">yii\base\Arrayable</a> interface.</td>
    </tr>
    <tr>
        <td><a href="yii-base-component.html">yii\base\Component</a></td>
        <td>Component is the base class that implements the <em>property</em>, <em>event</em> and <em>behavior</em> features.</td>
    </tr>
    <tr>
        <td><a href="yii-base-configurable.html">yii\base\Configurable</a></td>
        <td>Configurable is the interface that should be implemented by classes who support configuring
its properties through the last parameter to its constructor.</td>
    </tr>
    <tr>
        <td><a href="yii-base-model.html">yii\base\Model</a></td>
        <td>Model is the base class for data models.</td>
    </tr>
    <tr>
        <td><a href="yii-base-object.html">yii\base\Object</a></td>
        <td>Object is the base class that implements the <em>property</em> feature.</td>
    </tr>
    <tr>
        <td><a href="yii-db-activequery.html">yii\db\ActiveQuery</a></td>
        <td>ActiveQuery represents a DB query associated with an Active Record class.</td>
    </tr>
    <tr>
        <td><a href="yii-db-activequeryinterface.html">yii\db\ActiveQueryInterface</a></td>
        <td>ActiveQueryInterface defines the common interface to be implemented by active record query classes.</td>
    </tr>
    <tr>
        <td><a href="yii-db-activequerytrait.html">yii\db\ActiveQueryTrait</a></td>
        <td>ActiveQueryTrait implements the common methods and properties for active record query classes.</td>
    </tr>
    <tr>
        <td><a href="yii-db-activerecord.html">yii\db\ActiveRecord</a></td>
        <td>ActiveRecord is the base class for classes representing relational data in terms of objects.</td>
    </tr>
    <tr>
        <td><a href="yii-db-activerecordinterface.html">yii\db\ActiveRecordInterface</a></td>
        <td>ActiveRecordInterface</td>
    </tr>
    <tr>
        <td><a href="yii-db-activerelationtrait.html">yii\db\ActiveRelationTrait</a></td>
        <td>ActiveRelationTrait implements the common methods and properties for active record relational queries.</td>
    </tr>
    <tr>
        <td><a href="yii-db-baseactiverecord.html">yii\db\BaseActiveRecord</a></td>
        <td>ActiveRecord is the base class for classes representing relational data in terms of objects.</td>
    </tr>
    <tr>
        <td><a href="yii-db-query.html">yii\db\Query</a></td>
        <td>Query represents a SELECT SQL statement in a way that is independent of DBMS.</td>
    </tr>
    <tr>
        <td><a href="yii-db-queryinterface.html">yii\db\QueryInterface</a></td>
        <td>The QueryInterface defines the minimum set of methods to be implemented by a database query.</td>
    </tr>
    <tr>
        <td><a href="yii-db-querytrait.html">yii\db\QueryTrait</a></td>
        <td>The BaseQuery trait represents the minimum method set of a database Query.</td>
    </tr>
</table>
    </div>
</div>

<script type="text/javascript">
    /*<![CDATA[*/
    $("a.toggle").on('click', function () {
        var $this = $(this);
        if ($this.hasClass('properties-hidden')) {
            $this.text($this.text().replace(/Show/, 'Hide'));
            $this.parents(".summary").find(".inherited").show();
            $this.removeClass('properties-hidden');
        } else {
            $this.text($this.text().replace(/Hide/, 'Show'));
            $this.parents(".summary").find(".inherited").hide();
            $this.addClass('properties-hidden');
        }

        return false;
    });
    /*
     $(".sourceCode a.show").toggle(function () {
     $(this).text($(this).text().replace(/show/,'hide'));
     $(this).parents(".sourceCode").find("div.code").show();
     },function () {
     $(this).text($(this).text().replace(/hide/,'show'));
     $(this).parents(".sourceCode").find("div.code").hide();
     });
     $("a.sourceLink").click(function () {
     $(this).attr('target','_blank');
     });
     */
    /*]]>*/
</script>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Wed, 01 Feb 2017 19:59:15 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
});</script></body>
</html>
